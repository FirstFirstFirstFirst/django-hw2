{% extends 'myapp/base.html' %}

{% block myheader %}
<div class="pricing-header p-3 pb-md-4 mx-auto text-center">
    <h1 class="display-4 fw-normal">Prompt Evaluation</h1>
    <p class="fs-5 text-muted">Evaluate your prompts through automated testing and model-based grading</p>
</div>
{% endblock myheader %}

{% block content %}
<div class="row">
    <!-- Left Column: Prompt Input -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title">Submit Prompt for Evaluation</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="description" class="form-label">Description (Optional)</label>
                        <input type="text" class="form-control" name="description" id="description"
                               placeholder="Brief description of your prompt">
                    </div>
                    <div class="mb-3">
                        <label for="prompt_text" class="form-label">Prompt Text</label>
                        <textarea class="form-control" name="prompt_text" id="prompt_text" rows="8"
                                  placeholder="Enter your prompt here. For best results, design prompts that expect structured output (JSON, Python code, regex patterns, etc.)" required></textarea>
                        <div class="form-text">
                            <strong>Tip:</strong> Write prompts that expect structured outputs like JSON, Python code, or regex patterns for better evaluation results.
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Evaluate Prompt</button>
                </form>

                {% if error %}
                <div class="alert alert-danger mt-3">{{ error }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Evaluation Result -->
        {% if evaluation_result %}
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">Evaluation Results</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <h6>Average Score</h6>
                        <h2 class="text-primary">{{ evaluation_result.average_score }}/10</h2>
                    </div>
                    <div class="col-6">
                        <h6>Test Cases</h6>
                        <h2 class="text-secondary">{{ evaluation_result.total_test_cases }}</h2>
                    </div>
                </div>

                <h6 class="mt-4">Test Case Results:</h6>
                {% for result in evaluation_result.results %}
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>{{ result.test_case.expected_type|upper }}</strong>
                            <span class="badge bg-{% if result.result.score >= 8 %}success{% elif result.result.score >= 6 %}warning{% else %}danger{% endif %}">
                                {{ result.result.score }}/10
                            </span>
                        </div>
                        <p class="mb-2"><strong>Input:</strong> {{ result.test_case.input }}</p>
                        <details>
                            <summary>View Output & Reasoning</summary>
                            <div class="mt-2">
                                <strong>Output:</strong>
                                <pre class="bg-light p-2 mt-1"><code>{{ result.result.output }}</code></pre>
                                <strong>Reasoning:</strong>
                                <p class="mt-1">{{ result.result.reasoning }}</p>
                            </div>
                        </details>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Column: Prompt History -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Prompt History</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshPrompts()">Refresh</button>
            </div>
            <div class="card-body">
                <div id="promptHistory">
                    {% for prompt in recent_prompts %}
                    <div class="card mb-3 prompt-item" data-prompt-id="{{ prompt.id }}">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ prompt.description|default:"Untitled Prompt" }}</h6>
                                    <small class="text-muted">v{{ prompt.version }} • {{ prompt.created_at|date:"M d, Y H:i" }}</small>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                            data-bs-toggle="dropdown">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="viewPrompt({{ prompt.id }})">View Details</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="deletePrompt({{ prompt.id }})">Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                            <p class="mb-2 small">{{ prompt.text|truncatechars:100 }}</p>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Test Cases: <span id="tc-count-{{ prompt.id }}">-</span></small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Avg Score: <span id="avg-score-{{ prompt.id }}">-</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted">
                        <p>No prompts evaluated yet.</p>
                        <p>Submit a prompt to get started!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for viewing prompt details -->
<div class="modal fade" id="promptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prompt Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="promptModalBody">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let promptModal = new bootstrap.Modal(document.getElementById('promptModal'));

function refreshPrompts() {
    fetch('/prompt-eval/api/prompts/')
        .then(response => response.json())
        .then(data => {
            // Update prompt history
            const historyContainer = document.getElementById('promptHistory');
            if (data.prompts.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center text-muted">
                        <p>No prompts evaluated yet.</p>
                        <p>Submit a prompt to get started!</p>
                    </div>
                `;
                return;
            }

            historyContainer.innerHTML = data.prompts.map(prompt => `
                <div class="card mb-3 prompt-item" data-prompt-id="${prompt.id}">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${prompt.description || 'Untitled Prompt'}</h6>
                                <small class="text-muted">v${prompt.version} • ${new Date(prompt.created_at).toLocaleDateString()}</small>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown">
                                    Actions
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="viewPrompt(${prompt.id})">View Details</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="deletePrompt(${prompt.id})">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                        <p class="mb-2 small">${prompt.text.substring(0, 100)}${prompt.text.length > 100 ? '...' : ''}</p>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Test Cases: ${prompt.test_cases_count}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Avg Score: ${prompt.avg_score}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => console.error('Error refreshing prompts:', error));
}

function viewPrompt(promptId) {
    // Fetch test cases for this prompt
    fetch(`/prompt-eval/api/prompts/${promptId}/test-cases/`)
        .then(response => response.json())
        .then(data => {
            const modalBody = document.getElementById('promptModalBody');

            if (data.test_cases.length === 0) {
                modalBody.innerHTML = '<p>No test cases found for this prompt.</p>';
                promptModal.show();
                return;
            }

            modalBody.innerHTML = `
                <h6>Test Cases and Results:</h6>
                ${data.test_cases.map(tc => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>${tc.expected_type.toUpperCase()}</strong>
                                ${tc.score ? `<span class="badge bg-${tc.score >= 8 ? 'success' : tc.score >= 6 ? 'warning' : 'danger'}">${tc.score}/10</span>` : '<span class="badge bg-secondary">No Score</span>'}
                            </div>
                            <p class="mb-2"><strong>Input:</strong> ${tc.input}</p>
                            ${tc.output ? `
                                <details>
                                    <summary>View Output & Reasoning</summary>
                                    <div class="mt-2">
                                        <strong>Output:</strong>
                                        <pre class="bg-light p-2 mt-1"><code>${tc.output}</code></pre>
                                        <strong>Reasoning:</strong>
                                        <p class="mt-1">${tc.reasoning}</p>
                                    </div>
                                </details>
                            ` : '<p class="text-muted">No output available</p>'}
                        </div>
                    </div>
                `).join('')}
            `;
            promptModal.show();
        })
        .catch(error => {
            console.error('Error fetching prompt details:', error);
            document.getElementById('promptModalBody').innerHTML = '<p class="text-danger">Error loading prompt details.</p>';
            promptModal.show();
        });
}

function deletePrompt(promptId) {
    if (!confirm('Are you sure you want to delete this prompt and all its test cases?')) {
        return;
    }

    fetch('/prompt-eval/api/prompts/', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ id: promptId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            refreshPrompts();
        } else {
            alert('Error deleting prompt: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting prompt:', error);
        alert('Error deleting prompt');
    });
}

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    refreshPrompts();
});
</script>
{% endblock content %}